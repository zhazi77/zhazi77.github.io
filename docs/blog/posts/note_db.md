---
draft: true
date:
  created: 2025-01-22
categories:
  - Learning
  - Memo
tags:
  - Database
  - Memo
  - Summary
authors:
  - zhazi
---

# 青训营笔记：存储 & 数据库

!!! abstract ""

    记录学习存储 & 数据库过程中的思考与实践。

    # NOTE: 从课程中学习到别人是怎么看待这块知识的，是如何组织这各个知识点，然后按着他们的思路自己填充一遍
    # NOTE: 课件里面有很多 take home 的知识，把其中关于见解的部分摘录出来，了解专业人士是如何看待这块领域的

    - 先用例子引出数据存储的概念
    - 存储->数据库->分布式架构
    - 先大的分类再小的分类
    - 小的分类中举一些例子
    - 穿插着引入各种数据库中的概念
    - 结合技术演进进行思考背后的原因

    ??? info "参考文献"

        - 青训营课程
<!-- more -->

## 经典案例

### 一条数据的流动过程

用户产生结构化数据 => 后端服务器 => 数据库 

### 数据的持久化

校验数据合法性 => 修改内存 => 写入存储介质


??? question "数据库怎么保证**数据不丢失**？"
??? question "数据库怎么处理**多人同时修改**？"
??? question "除里数据库还有**别的存储系统**吗？"
??? question "数据库只能处理**结果化数据**吗？"
??? question "有那些操作数据库的方式？要用什么**编程语言**？"

## 存储系统与数据库简介

!!! qoute "存储系统"

    一个提供了读写、控制类接口，能够安全有效地把数据持久化的软件，就可以称为**存储系统**

存储系统可能涉及的对象有：用户、存储介质、**内存**、**网络**

存储系统的特点：

- 做为后端软件的底座，**性能敏感**
- 存储系统**代码**，**既简要又复杂**
- 存储系统软件架构，**容易受硬件影响**

### 存储器层级架构

!!! note "Persistent Memory"

### 数据怎么从应用到存储介质

- **缓存**很重要，贯穿整个存储体系
- **拷贝**很昂贵，应该尽量减少
- 硬件设备五花八门，需要有抽象统一的接入层

!!! note "ACID"

    - **A**tomicity（原子性）：事务中的所有操作要么全部成功，要么全部失败  
    - **C**onsistency（一致性）：事务中的每个操作都必须是合法的，即数据库应该从一个有效状态变为另一个有效状态
    - **I**solation（隔离性）：并发事务之间互不干扰，表现的像是串行执行的
    - **D**urability（持久性）：事务提交后，对数据的修改是永久性的，不会因为宕机等问题而丢失。

### RAID 技术

### 关系型数据库

关系型数据库是存储系统，但在存储之外，又发展出其他能力。

- 结构化数据友好
- 支持事务（ACID）
- 支持 SQL 语法

### 非关系型数据库

非关系型数据库也是存储系统，但是一般不要求严格的结构化。


- 半结构化数据友好
- 可能支持事务（ACID）
- 可能支持 SQL 语法

### 数据库与经典存储

- 结果化数据存储能力
- 事务能力
- 复杂查询能力

## 主流产品剖析

### 单机存储 —— 本地文件系统

例子： Linux 文件系统

!!! note "一切皆文件"

- 文件系统的管理单元是文件，不同的文件系统都遵循 VFS 的统一抽象接口
- Linux 文件系统的两大数据结构： Index Node & Directory Entry
    - Index Node 的总数在格式化文件系统时就固定了！(没有扩容缩容的概念)

### 单机存储 —— Key-Value 存储

例子：RocksDB

!!! note "LSM-Tree"

    某种成都上牺牲读性能，追求写入性能

#### 内存数据结构 
    - MemTable 
    - Immutable MemTabler
    - MemTable 满了就刷到 Immutable MemTable 然后慢慢写到磁盘中
    - 不断的往下刷

#### 磁盘数据结构

### 分布式存储 —— HDFS

大数据时代的基石

- 支持海量数据存储
- 高容错性
- 弱 POXIS 语义
- 使用普通的 x86 服务器，性价比高

#### 内存数据结构

#### 磁盘数据结构


### 分布式存储 —— Ceph

开源分布式存储系统里的万金油

- 支持对象接口，块接口，文件接口，但一切皆对象
- 数据写入采用主备复制模型
- 数据分布模型采用 CRUSH 算法

!!! note "主备复制模型"

!!! note "CRUSH 算法"

    HASH + 权重 + 随机抽签

### 单机数据库 —— 概览

单机数据库：单个计算机节点上的数据库系统
事务在单机内执行，也可能通过网络交互实现分布式事务

关系型数据库 & 非关系型数据库

### 单机数据库 —— 关系型数据库

!!! qoute "摘录"

    商业产品 Oracle 称王，开源产品 MySQL & PostgreSQL 称霸


#### 关系型数据库的通用组件

- Query Engine
- Txn Manager
- Lock Manager
- Storage Engine
- Replication
- 关键内存数据结构: 各种树
- 关键磁盘数据结构: Redo Log, Page, 临时数据

### 单机数据库 —— 非关系型数据库

!!! qoute "摘录"

    MongoDB, Reids, Elasticsearch 三足鼎立

- 非关系型数据库一般直接使用 SQL 交互，而非关系型数据库交互方式各不相同
- 非关系型数据库的数据结构（scheme）相对灵活（因为没有关系的约束）
- 不管是否关系型，都在尝试支持 SQL（子集）和事务

介绍逻辑： 

- scheme
- 存储和构建索引的方式
- 支持的功能
- 交互方式

#### Elasticsearch

!!! qoute "摘录"

    与 RDBMS 相比，ES 天然能做「模糊匹配」，还能自动算出关联程度

- 面向文档存储
- 文档可序列化成 JSON，支持嵌套
- 存在 index， index 为文档的集合 
- 存储和构建索引能力依赖 Lucene 引擎
- 实现了大量搜索数据结构 & 算法
- 支持了 RESTFUL API 交互，也支持弱 SQL 交互

#### MongoDB

- 面向文档存储
- 文档可序列化成 JSON，支持嵌套
- 存在 collection, colletion  为文档的集合
- 存储和构建索引能力依赖 wiredTiger 引擎
- 4.0 后开始支持**事务**（多文档、跨分片多文档等）
- 常用 client/SDK 交互，可通过插件转译支持弱 SQL

#### Redis

- 数据结构丰富
- C 语言实现，超高性能
- 主要基于内存，但支持 AOF/RDB 持久化
- 常用 redis-cli/多语言 SDK 交互


### 思考：从单机到分布式数据库 Part1

!!! question "单机数据库遇到了哪些问题/挑战，需要我们引入**分布式架构**来解决？"


#### 容量问题

#### 弹性问题

#### 性价比问题

单点容量有限，受硬件限制 => 存储节点池化，动态扩缩容


### 思考：从单机到分布式数据库 Part2

!!! question "引入**分布式架构**带来哪些新的问题？"

#### 单写 vs 多写

怎么实现单用户写 => 多用户写？

#### 从磁盘弹性到内存弹性

#### 分布式事务优化

## 新技术演进

什么新技术？

- 新架构？
- 新硬件？
- 新理论？
- 人工智能？

未来的方向？

- 软件架构变更
    - Bypass OS kernel: 尝试绕过对操作系统读写接口的依赖来获得优化
- AI 增强
    - 智能存储格式转换: 
- **新硬件革命**
    - 存储介质变更
    - 计算单元变更
    - 网络硬件变更

### Bypass OS Knernal —— SPDK

!!! qoute "摘录"

    Bypass OS Kernel 已经成为一种趋势

- Kernel Space -> User Space
    - 避免 syscall 带来的性能损耗，直接从用户态访问磁盘
- 中断 -> 轮询
    - 磁盘性能提高后，中断次数随之上升，不利于 IO 性能
        - 以前速度慢，中断避免 CPU 白白浪费时间有好处，现在速度上来后，CPU 刚走一会就被叫回来了，还可能中断套中断没完没了。
    - SPDK poller 可以绑定特定的 CPU 核不断论询，减少上下文切换, 提高性能
- 无锁数据结构
    - 使用 Lock-free queue, 降低并发时的同步开销

### AI for Storage —— 存储格式转换

- AI 决策的行列混存

### 高性能硬件

1. RDMA 网络
2. Persistent Memory
3. 可编程交换机
4. CPU/GPU/DPU
    - CPU: multi-core -> many-core
    - GPU: 强大的算力 & 越来越的的显存
    - DPU：异构计算，减轻 CPU 的 workLoad

## 总结

### 存储系统

### 数据库系统

### 分布式架构

!!! quote "摘录"

    在存储 & 数据库领域，硬件反推软件变革十分常见！


!!! example "课后作业"

    实现一个（分布式）key-value 存储系统

    略
