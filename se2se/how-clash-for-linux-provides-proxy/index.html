<!DOCTYPE html><html lang="zh" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A personal knowledge base for storing notes, research, and technical documentation">
      
      
        <meta name="author" content="Zhazi">
      
      
      
        <link rel="prev" href="../why-some-downloads-resume-and-others-dont/">
      
      
        <link rel="next" href="../../record/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Clash for Linux 是怎么提供网关代理的？ - Zhazi's Memo</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Sans:300,300i,400,400i,700,700i%7CFira+Mono:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Fira Sans";--md-code-font:"Fira Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../_static/css/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="red">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#clash-for-linux" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Zhazi's Memo" class="md-header__button md-logo" aria-label="Zhazi's Memo" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Zhazi's Memo
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Clash for Linux 是怎么提供网关代理的？
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="red" aria-label="切换至深色模式" type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="切换至深色模式" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="blue" aria-label="切换至浅色模式" type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="切换至浅色模式" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/the-full/the-full.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
  </div>
  <div class="md-source__repository">
    Memo
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../why-some-downloads-resume-and-others-dont/" class="md-tabs__link">
          
  
  
    
  
  浅入浅出

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../record/" class="md-tabs__link">
          
  
  
    
  
  实践记录

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../note/go-reflection/" class="md-tabs__link">
          
  
  
    
  
  学习笔记

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../paper/ACE/" class="md-tabs__link">
          
  
  
    
  
  论文阅读

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../translation/" class="md-tabs__link">
          
  
  
    
  
  文献翻译

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../algorithm/" class="md-tabs__link">
          
  
  
    
  
  算法

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Zhazi's Memo" class="md-nav__button md-logo" aria-label="Zhazi's Memo" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    Zhazi's Memo
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/the-full/the-full.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
  </div>
  <div class="md-source__repository">
    Memo
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    浅入浅出
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    浅入浅出
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../why-some-downloads-resume-and-others-dont/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    为什么有的下载能接着下，有的断了就得重来？
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Clash for Linux 是怎么提供网关代理的？
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Clash for Linux 是怎么提供网关代理的？
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#clash" class="md-nav__link">
    <span class="md-ellipsis">
      
        Clash 提供的三个入口
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        显式代理：程序自己送
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        显式代理下的常见问题分析
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        透明代理：系统帮忙送
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        网关模式：帮外部流量做代理
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="网关模式：帮外部流量做代理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        设置网关模式
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="设置网关模式">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-ip" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 开启 IP 转发
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-nat" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 清空旧的 NAT 规则（⚠️非必要，且有风险）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. 保护本机对代理端口的直接访问（非必要）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-tcp" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. 重定向外部 TCP 流量到透明代理端口
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-nat" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. 启用转发放行 + 出口 NAT（补充步骤）
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        持久化开启（可选）
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="持久化开启（可选）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#etcrclocal" class="md-nav__link">
    <span class="md-ellipsis">
      
        方案一：使用 /etc/rc.local
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#systemd" class="md-nav__link">
    <span class="md-ellipsis">
      
        方案二：创建专用 systemd 服务
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      
        结语
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      
        参考文献
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3">
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../record/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    实践记录
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    实践记录
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../record/common_problem/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    普通问题归档
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../record/waymo_perprocess/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    waymo 数据预处理遇到的问题
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../record/openpcdet_waymo_training/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    基于 OpenPCDet 在 Waymo 数据集上训练模型
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../record/openpcdet_waymo_process/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    对 Waymo 数据集做加工
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../record/luogu-U207568/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    杂记：洛谷 U207568
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../record/LLM-TinyRAG/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LLM 学习：RAG
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../record/LLM-Milvus/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LLM 学习：Milvus
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4">
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    学习笔记
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    学习笔记
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../note/go-reflection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Go 语言基础：反射
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../note/ssh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ssh 笔记
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../note/rsync/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    rsync 笔记
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../note/modelnet40/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ModelNet40 归纳
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../note/useful_linux_app/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Linux 有用软件归纳
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../note/useful_blog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    优质博客归纳
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../note/3D-Adv-01-CW-Attack/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    三维点云对抗攻击反思录(一) —— C&amp;W Attack
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../note/3D-Adv-02-CW-Attack-framework/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    三维点云对抗攻击反思录(二) —— C&amp;W Attack 框架
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5">
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    论文阅读
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    论文阅读
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../paper/ACE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ACE
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../paper/GradCraft/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GradCraft
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../paper/occupancy_network/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Occupancy Network
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6">
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../translation/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    文献翻译
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    文献翻译
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../translation/Go-Data-Structures-Interfaces/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Go 语言数据结构：接口
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../translation/The-Laws-of-Reflection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Go 语言的反射定律
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../translation/Scale-with-Redis-Cluster/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    使用 Redis 集群进行扩展
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../translation/A-plain-english-introduction-to-CAP-Theorem/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CAP 定理的简明介绍
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../translation/tetris/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    BUILDING CONTROLLERS FOR TETRIS
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../translation/tetris2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Learning Tetris Using the Noisy Cross-Entropy Method
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../translation/CWA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CWA
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../translation/SR-Adv/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SR-Adv
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../translation/AL-Adv/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AL-Adv
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../translation/PartA2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PartA2
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../translation/kafka/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Kafka
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../translation/Cyber-Physical-Systems-Security-A-Survey/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cyber-Physical Systems Security—A Survey
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../translation/sok-semantic-ai-security-in-ad/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SoK: On the Semantic AI Security in Autonomous Driving
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../translation/sok-adv-for-network-intrusion-detection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SoK: Realistic Adversarial Attacks and Defenses for Intelligent Network Intrusion Detection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7">
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../algorithm/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    算法
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7" id="__nav_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    算法
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2">
        
          
          <label class="md-nav__link" for="__nav_7_2" id="__nav_7_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    归档
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    归档
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../algorithm/archive/2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    三月 2025
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3">
        
          
          <label class="md-nav__link" for="__nav_7_3" id="__nav_7_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    分类
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    分类
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../algorithm/category/algorithm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Algorithm
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../algorithm/category/note/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Note
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#clash" class="md-nav__link">
    <span class="md-ellipsis">
      
        Clash 提供的三个入口
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        显式代理：程序自己送
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        显式代理下的常见问题分析
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        透明代理：系统帮忙送
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        网关模式：帮外部流量做代理
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="网关模式：帮外部流量做代理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        设置网关模式
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="设置网关模式">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-ip" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 开启 IP 转发
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-nat" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 清空旧的 NAT 规则（⚠️非必要，且有风险）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. 保护本机对代理端口的直接访问（非必要）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-tcp" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. 重定向外部 TCP 流量到透明代理端口
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-nat" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. 启用转发放行 + 出口 NAT（补充步骤）
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        持久化开启（可选）
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="持久化开启（可选）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#etcrclocal" class="md-nav__link">
    <span class="md-ellipsis">
      
        方案一：使用 /etc/rc.local
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#systemd" class="md-nav__link">
    <span class="md-ellipsis">
      
        方案二：创建专用 systemd 服务
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      
        结语
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      
        参考文献
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/the-full/the-full.github.io/edit/master/docs/se2se/how-clash-for-linux-provides-proxy.md" title="编辑此页" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"></path></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/the-full/the-full.github.io/raw/master/docs/se2se/how-clash-for-linux-provides-proxy.md" title="查看本页的源代码" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"></path></svg>
    </a>
  


<h1 id="clash-for-linux">Clash for Linux 是怎么提供网关代理的？<a class="headerlink" href="#clash-for-linux" title="Permanent link">¶</a></h1>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../images/clash-for-linux-%E7%A7%91%E7%A0%94%E5%B0%8F%E6%95%85%E4%BA%8B%E4%B8%80%E5%88%99.png" data-desc-position="bottom"><img alt="" src="../images/clash-for-linux-%E7%A7%91%E7%A0%94%E5%B0%8F%E6%95%85%E4%BA%8B%E4%B8%80%E5%88%99.png"></a></p>
<p class="caption">科研小故事一则</p>
<p>很多人第一次用 Clash for Linux 时，往往会下意识地这么想：</p>
<blockquote>
<p>我把 Clash 启动了 → 它“提供代理” → 于是需要代理的地方就都会自动走代理。</p>
</blockquote>
<p>但很快就会碰到现实的反例：同一台机器上，有的请求已经顺畅地走了代理，有的却像什么都没开一样。比如终端里某些命令行工具正常，而浏览器访问 Google 仍然失败；或者反过来，浏览器好了，换个程序就不行。</p>
<p>比较细心的同学可能会发现，<a href="https://github.com/wnlen/clash-for-linux">项目主页</a> 上有这样一段“设置代理”的命令：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># 开启 IP 转发</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">"net.ipv4.ip_forward = 1"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/etc/sysctl.conf
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>sudo<span class="w"> </span>sysctl<span class="w"> </span>-p
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="c1"># 先清空旧规则</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>sudo<span class="w"> </span>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-F
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="c1"># 允许本机访问代理端口（避免把自己绕进去）</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>sudo<span class="w"> </span>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>OUTPUT<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">7890</span><span class="w"> </span>-j<span class="w"> </span>RETURN
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>sudo<span class="w"> </span>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>OUTPUT<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">7891</span><span class="w"> </span>-j<span class="w"> </span>RETURN
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>sudo<span class="w"> </span>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>OUTPUT<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">7892</span><span class="w"> </span>-j<span class="w"> </span>RETURN
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="c1"># 让所有 TCP 流量通过 7892 代理</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>sudo<span class="w"> </span>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>PREROUTING<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-j<span class="w"> </span>REDIRECT<span class="w"> </span>--to-ports<span class="w"> </span><span class="m">7892</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="c1"># 保存规则</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>sudo<span class="w"> </span>iptables-save<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/etc/iptables.rules
</span></code></pre></div>
<p>看起来是专业的解决方案。但照着做了，却发现问题并没有得到解决，更糟糕的是，还多了一个新的困惑：那这些命令到底在做什么？</p>
<p>因此，本文希望帮助你：</p>
<ul>
<li>
<p><strong>形成这样的认识</strong>： Clash 自己并不会“自动接管所有流量”。它只是提供了几个本地端口作为“代理入口”；一个程序能不能走代理，最直接的区别在于——它的请求有没有被送到这些“入口”。</p>
</li>
<li>
<p><strong>理解这段设置代理的命令</strong>：这段 <code>iptables</code> 的命令并不是给本机所有程序“自动走代理”用的——它主要是为了让其他设备（比如你的手机或另一台电脑）通过这台 Linux 机器上网时能走 Clash 代理。它的核心原理很简单：把从外部进来的网络请求，用 REDIRECT 规则“改道”到 Clash 监听的透明代理端口（这里是 7892）。</p>
</li>
</ul>
<p>甚至是</p>
<ul>
<li><strong>能够看懂别人的解决方案</strong>：比如<a href="https://payloads.online/archivers/2023-08-07/clash-config/">记录一下配置Clash透明代理</a>，了解怎么配置本机透明代理，让本机所有程序“自动走代理”。</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">注意</p>
<p>本文将基于 <a href="https://github.com/wnlen/clash-for-linux">Clash for Linux</a> 的默认配置展开。要达成目标3会涉及到一些网络虚拟化的知识，因此（将来可能会）在文末增加拓展内容的形式来实现。</p>
</div>
<h2 id="clash">Clash 提供的三个入口<a class="headerlink" href="#clash" title="Permanent link">¶</a></h2>
<p>Clash 启动后，默认会监听三个端口：</p>
<p><a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../images/clash-for-linux-%E7%AB%AF%E5%8F%A3%E7%9B%91%E5%90%AC%E6%83%85%E5%86%B5.png" data-desc-position="bottom"><img alt="" src="../images/clash-for-linux-%E7%AB%AF%E5%8F%A3%E7%9B%91%E5%90%AC%E6%83%85%E5%86%B5.png"></a></p>
<p class="caption">Clash 默认端口监听情况</p>
<details class="info">
<summary>命令解释</summary>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>sudo<span class="w"> </span>ss<span class="w"> </span>-tulnp<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-i<span class="w"> </span>clash
</span></code></pre></div>
<ul>
<li><code>sudo</code>：以超级用户权限执行命令，用于查看系统所有监听端口（包括需要权限的端口）</li>
<li><code>ss</code>：Socket Statistics 的缩写，是现代 Linux 系统中用于查看网络连接状态的工具，功能类似 <code>netstat</code> 但更高效</li>
<li><code>-t</code>：显示 <strong>TCP</strong> 连接</li>
<li><code>-u</code>：显示 <strong>UDP</strong> 连接</li>
<li><code>-l</code>：仅显示 <strong>监听状态</strong>（listening）的套接字</li>
<li><code>-n</code>：以数字形式显示地址和端口（不解析主机名或服务名）</li>
<li><code>-p</code>：显示使用该 socket 的 <strong>进程信息</strong>（包括 PID 和程序名）</li>
<li><code>|</code>：管道符，将前一个命令的输出作为下一个命令的输入</li>
<li><code>grep -i clash</code>：在输出中搜索包含 "clash" 的行，<code>-i</code> 表示忽略大小写</li>
</ul>
<p><strong>翻译：</strong> 查看当前系统中所有正在监听的 TCP/UDP 端口，并筛选出与 Clash 相关的进程及其监听端口信息</p>
</details>
<p>它们都能让请求“走代理”，具体差异如下：</p>
<table>
<thead>
<tr>
<th>代理入口类型</th>
<th>默认端口</th>
<th>如何使用</th>
<th>是否需要 iptables</th>
</tr>
</thead>
<tbody>
<tr>
<td><abbr title="Hypertext Transfer Protocol">HTTP</abbr> 代理</td>
<td>7890</td>
<td>在支持 <abbr title="Hypertext Transfer Protocol">HTTP</abbr> 代理的应用中设置 <code>127.0.0.1:7890</code></td>
<td>❌ 不需要</td>
</tr>
<tr>
<td>SOCKS5 代理</td>
<td>7891</td>
<td>在支持 SOCKS5 的应用中设置 <code>127.0.0.1:7891</code></td>
<td>❌ 不需要</td>
</tr>
<tr>
<td>透明代理</td>
<td>7892</td>
<td>配合 iptables 规则，自动代理所有流量</td>
<td>✅ 需要</td>
</tr>
</tbody>
</table>
<blockquote>
<p>💡 这些端口在 <code>config.yaml</code> 中分别由 <code>port</code>、<code>socks-port</code> 和 <code>redir-port</code> 控制，可根据需要修改。</p>
</blockquote>
<p>最主要的差别是：</p>
<ul>
<li>7890/7891 端口：程序自己把请求送来，即<strong>显式代理</strong></li>
<li>7892 端口：系统把请求改道送来，<strong>透明代理</strong></li>
</ul>
<h2 id="_1">显式代理：程序自己送<a class="headerlink" href="#_1" title="Permanent link">¶</a></h2>
<p>7890（<abbr title="Hypertext Transfer Protocol">HTTP</abbr>）和 7891（SOCKS5）端口提供的是“显式代理”。意思是：应用程序必须<strong>主动连接</strong>这些端口，并明确告诉 Clash：“我想访问 example.com”。</p>
<p>比如你在终端里这样用：
</p><div class="language-bash highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">https_proxy</span><span class="o">=</span>http://127.0.0.1:7890
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>curl<span class="w"> </span>https://example.com
</span></code></pre></div>
<code>curl</code> 就会直接连到本地 7890 端口，把目标地址一并告诉 Clash。Clash 拿到后，会按配置决定是代理、直连，还是拒绝。<p></p>
<p>这类代理对系统几乎没有要求。Clash 此时就像一个普通的本地服务——和你运行的 Web 服务器或数据库没本质区别。只要程序支持设置代理（大多数命令行工具都支持），就能正常工作。</p>
<p>但问题也很直接：如果某个程序压根不知道要设代理（比如图形界面软件、Docker 容器、systemd 服务），它的流量就完全绕过 Clash，该直连还是直连。</p>
<h2 id="_2">显式代理下的常见问题分析<a class="headerlink" href="#_2" title="Permanent link">¶</a></h2>
<p>到这里，我们已经可以解释开头“科研小故事”中的问题了：为什么开启代理后，我能正常下载 PyTorch, 但 sudo apt update 还是不能正常连接？</p>
<p>答案其实非常朴素——<strong>因为 7890 是显式代理入口</strong>。</p>
<p>这意味着，只有那些“知道自己要走代理”的程序，才会主动把网络请求发往这个端口。对于大多数命令行工具来说，它们是通过读取环境变量（如 <code>http_proxy</code> 和 <code>https_proxy</code>）来决定是否使用代理的。</p>
<p>而 Clash for Linux 提供的 <code>proxy_on</code> 函数，本质上就是在<strong>当前终端会话</strong>中设置这样一组环境变量，从而告诉这些命令行工具代理入口。</p>
<div class="language-bash highlight"><span class="filename">/etc/profile.d/clash.sh</span><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>proxy_on<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">        </span><span class="nb">export</span><span class="w"> </span><span class="nv">http_proxy</span><span class="o">=</span>http://127.0.0.1:7890
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">        </span><span class="nb">export</span><span class="w"> </span><span class="nv">https_proxy</span><span class="o">=</span>http://127.0.0.1:7890
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">        </span><span class="nb">export</span><span class="w"> </span><span class="nv">no_proxy</span><span class="o">=</span><span class="m">127</span>.0.0.1,localhost
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">        </span><span class="nb">export</span><span class="w"> </span><span class="nv">HTTP_PROXY</span><span class="o">=</span>http://127.0.0.1:7890
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">        </span><span class="nb">export</span><span class="w"> </span><span class="nv">HTTPS_PROXY</span><span class="o">=</span>http://127.0.0.1:7890
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">        </span><span class="nb">export</span><span class="w"> </span><span class="nv">NO_PROXY</span><span class="o">=</span><span class="m">127</span>.0.0.1,localhost
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">"\033[32m[√] 已开启代理\033[0m"</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="o">}</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="c1"># 关闭系统代理</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>proxy_off<span class="o">(){</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="w">        </span><span class="nb">unset</span><span class="w"> </span>http_proxy
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="w">        </span><span class="nb">unset</span><span class="w"> </span>https_proxy
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="w">        </span><span class="nb">unset</span><span class="w"> </span>no_proxy
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="w">        </span><span class="nb">unset</span><span class="w"> </span>HTTP_PROXY
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="w">        </span><span class="nb">unset</span><span class="w"> </span>HTTPS_PROXY
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a><span class="w">        </span><span class="nb">unset</span><span class="w"> </span>NO_PROXY
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">"\033[31m[×] 已关闭代理\033[0m"</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a><span class="o">}</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>......
</span></code></pre></div>
<p>因此，相关问题总是出在：<strong>需要代理的流量，没有被送到正确的位置上</strong>。例如：</p>
<details class="example" open="open">
<summary>代理开启了，为什么 sudo apt update 还是连不上？</summary>
<p>这是一个极具迷惑性的坑：同一个终端里，普通 <code>curl</code> 好好的，一加 <code>sudo</code> 就不行。</p>
<p>其实原因并不不复杂：<strong><code>sudo</code> 默认不会把这些环境变量原封不动地传给 root 的进程。</strong></p>
<p>于是 <code>sudo apt update</code> 完全看不到 <code>http_proxy/https_proxy</code>，于是还是直连导致更新失败</p>
<p>所以一个很简单的解决办法就是保留环境变量：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>sudo<span class="w"> </span>-E<span class="w"> </span>apt<span class="w"> </span>update<span class="w"> </span><span class="c1"># -E：保留当前环境变量</span>
</span></code></pre></div>
</details>
<details class="example">
<summary>为什么这个终端可以，新开一个终端又不行了？</summary>
<p>原因同样直接：<code>proxy_on</code> 设置的是<strong>当前 shell 进程的环境变量</strong>，属于临时生效的会话级配置，并非系统全局状态。</p>
<ul>
<li><strong>当前终端</strong>：已执行 <code>proxy_on</code> → 环境变量存在 → 程序知道代理入口  </li>
<li><strong>新开终端</strong>：启动了全新的 shell 进程 → 没有继承之前的 <code>export</code> → 代理“消失”</li>
</ul>
<p>所以新终端里的命令（如 <code>pip</code>、<code>curl</code>）自然不会走代理。</p>
<p>那么一个简单的解决办法就是在新终端中手动设置环境变量：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">'export http_proxy=http://127.0.0.1:7890'</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>~/.bashrc
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">'export https_proxy=http://127.0.0.1:7890'</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>~/.bashrc
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">'export no_proxy=127.0.0.1,localhost'</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>~/.bashrc
</span></code></pre></div>
</details>
<details class="example">
<summary>终端能下 PyTorch，但浏览器还是打不开 Google?</summary>
<p>这个问题和上一个本质相同，只是发生在不同类型的程序上。</p>
<p><code>proxy_on</code> 仅在<strong>当前终端的环境</strong>中设置了代理变量，因此只有<strong>从该终端启动的程序及其子进程</strong>才会读取这些变量并使用代理。</p>
<p>而大多数桌面浏览器（如 Chrome、Firefox）是由图形界面（如 GNOME 或 KDE）直接启动的：</p>
<ul>
<li>它们<strong>不是当前 shell 的子进程</strong></li>
<li>也<strong>不会主动读取你在某个终端里设置的环境变量</strong></li>
</ul>
<p>所以，浏览器的流量依然走直连，访问 Google 自然失败。</p>
<p>解决方法并不神秘：<strong>只需在浏览器的网络设置中手动配置代理</strong>，例如：
- <abbr title="Hypertext Transfer Protocol">HTTP</abbr> 代理：<code>127.0.0.1:7890</code>
- SOCKS5 代理：<code>127.0.0.1:7891</code></p>
<p>这本质上就是让浏览器<strong>显式地把请求发送到 Clash 提供的代理入口</strong>，从而纳入代理规则的管理范围。</p>
</details>
<h2 id="_3">透明代理：系统帮忙送<a class="headerlink" href="#_3" title="Permanent link">¶</a></h2>
<p>为了解决“程序不配合”的问题，Clash 还提供了 7892 端口（<code>redir-port</code>），用于透明代理。</p>
<p>所谓“透明”，指的是：<strong>程序完全不知道自己在走代理</strong>。它依然像平常一样直连目标站点（例如 <code>curl https://example.com</code>），但在数据包真正发出前，Linux 内核会把这条连接<strong>悄悄改道</strong>到本地的 7892 端口，让 Clash 来处理。</p>
<p>这依赖 Linux 内核的 <strong>Netfilter 框架</strong>——它在网络协议栈的关键路径上设置了可编程的检查点（hook），允许对流经的数据包进行拦截或修改。而开头那串命令中的 <code>iptables</code> 就是用户空间用来配置这些检查点行为的工具。</p>
<p>最典型的规则配置长这样：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>OUTPUT<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-j<span class="w"> </span>REDIRECT<span class="w"> </span>--to-ports<span class="w"> </span><span class="m">7892</span>
</span></code></pre></div>
<p>它的意思是：“本机进程发出的 TCP 连接的流量，先别出网，改道送到 7892”。</p>
<details class="info">
<summary>一些被扫到地毯下的细节</summary>
<p>实际配置中，为了避免 Clash 自己的流量也被重定向（造成代理循环），通常需要专门创建一个新用户（比如叫 clash）来运行 Clash，并在 iptables 规则中跳过这个用户的流量。
同时，还要排除发往本机（如 127.0.0.1）的连接，否则本地服务（比如开发服务器）也会被错误代理。</p>
<p>另外，这些配置只对 TCP 有效。UDP（如 QUIC、DNS）和 ICMP（如 <code>ping</code>）不会走 7892 端口。想覆盖 UDP 通常要用 TProxy 等更“硬核”的方案。</p>
</details>
<details class="note">
<summary>Netfilter 的五条内置链（Chains）</summary>
<p>Netfilter 在数据包穿越网络协议栈时设定了五个标准检查点（称为“链”），每条链对应不同的流量路径：</p>
<ul>
<li><strong>PREROUTING</strong>：刚进入网络接口的数据包（在路由决策前）</li>
<li><strong>INPUT</strong>：发往本机进程的数据包（路由后，交付前）</li>
<li><strong>FORWARD</strong>：需要本机转发的数据包（非本机目的地）</li>
<li><strong>OUTPUT</strong>：本机进程主动发出的数据包（发送前）</li>
<li><strong>POSTROUTING</strong>：即将离开本机的数据包（路由和 NAT 后）</li>
</ul>
<p><code>iptables</code> 规则就是添加到这些链上的。例如，透明代理中用到的 <code>-A OUTPUT</code>，就是在 <strong>本机出站流量</strong> 路径上插入规则。</p>
<p>更具体的介绍见：<a href="https://icyfenix.cn/immutable-infrastructure/network/linux-vnet.html">Linux 网络虚拟化</a></p>
</details>
<details class="info">
<summary>命令解释</summary>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>OUTPUT<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-j<span class="w"> </span>REDIRECT<span class="w"> </span>--to-ports<span class="w"> </span><span class="m">7892</span>
</span></code></pre></div>
<ul>
<li><code>-t nat</code>：使用 <strong>nat 表</strong>（存放以“改地址/改端口”为目的的规则的表）</li>
<li><code>-A OUTPUT</code>：作用于 <strong>本机进程发出的连接</strong></li>
<li><code>-p tcp</code>：只处理 <strong>TCP</strong> 流量</li>
<li><code>-j REDIRECT --to-ports 7892</code>：把匹配到的连接 <strong>改道到本机 7892 端口</strong></li>
</ul>
<p><strong>翻译：</strong>把“本机发出的 TCP 数据包”在出网前拦下来，统一送到 <code>127.0.0.1:7892</code> 让 Clash 接管。</p>
</details>
<h2 id="_4">网关模式：帮外部流量做代理<a class="headerlink" href="#_4" title="Permanent link">¶</a></h2>
<p>项目主页中“设置代理”的那一串命令其实是在配置<strong>网关模式</strong>——让这台 Linux 机器为局域网中的其他设备（比如连热点的手机）提供透明代理。</p>
<p>和本机透明代理使用 <code>OUTPUT</code> 链不同，网关模式需要在 <strong><code>PREROUTING</code> 链</strong> 上添加规则：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>PREROUTING<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-j<span class="w"> </span>REDIRECT<span class="w"> </span>--to-ports<span class="w"> </span><span class="m">7892</span>
</span></code></pre></div>
<p>因为来自外部设备的流量<strong>不是本机进程发出的</strong>，而是从网卡进入后、路由决策前就到达 <code>PREROUTING</code>。只有在这里拦截，才能把它们重定向到 Clash 的 7892 端口。</p>
<h3 id="_5">设置网关模式<a class="headerlink" href="#_5" title="Permanent link">¶</a></h3>
<p>现在，我们可以逐行解读项目主页给出的那段“设置代理”命令，看看它是怎么让 Clash 成为网关的，并完成开头约定的第二个目标。</p>
<h4 id="1-ip">1. 开启 IP 转发<a class="headerlink" href="#1-ip" title="Permanent link">¶</a></h4>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">"net.ipv4.ip_forward = 1"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/etc/sysctl.conf
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>sudo<span class="w"> </span>sysctl<span class="w"> </span>-p
</span></code></pre></div>
<p>这两行命令启用 Linux 的 IP 转发功能，使这台机器具备“路由器/网关”的能力：当局域网设备把它设为默认网关时，<strong>未被 Clash 接管的流量</strong>也能被系统正常转发到外网。否则这些需要转发的包会在内核转发路径被丢弃/拒绝，表现为“部分网站/应用不通”。</p>
<details class="info">
<summary>命令解释</summary>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">"net.ipv4.ip_forward = 1"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>-a<span class="w"> </span>/etc/sysctl.conf
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>sudo<span class="w"> </span>sysctl<span class="w"> </span>-p
</span></code></pre></div>
<ul>
<li><code>echo "net.ipv4.ip_forward = 1"</code>：生成一行内核参数配置，启用 IPv4 包转发功能  </li>
<li><code>|</code>：将该行内容通过管道传递给下一个命令  </li>
<li><code>sudo tee -a /etc/sysctl.conf</code>：以超级用户权限将内容<strong>追加</strong>写入 <code>/etc/sysctl.conf</code>（系统级内核参数配置文件）  </li>
<li><code>sudo sysctl -p</code>：从默认配置文件（通常是 <code>/etc/sysctl.conf</code>）<strong>重新加载</strong>所有内核参数  </li>
</ul>
<p><strong>翻译：</strong> 立即且永久性地开启 Linux 的 IP 转发能力，使本机可以作为路由器转发来自其他设备的网络流量。</p>
</details>
<h4 id="2-nat">2. 清空旧的 NAT 规则（⚠️非必要，且有风险）<a class="headerlink" href="#2-nat" title="Permanent link">¶</a></h4>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>sudo<span class="w"> </span>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-F
</span></code></pre></div>
<p>这行命令清空 <code>nat</code> 表中的所有规则。这么做是为了避免旧规则（比如之前配置的 Docker 网络、手动添加的端口转发等）与新规则冲突。  </p>
<div class="admonition warning">
<p class="admonition-title">破坏性操作注意</p>
<p>这么做会导致系统中那些着依赖 NAT 的服务（如容器、虚拟机）的网络受到影响，直到你重新配置或重启相关服务。</p>
<p>推荐的工程做法：不要 flush 全表，而是把 Clash 相关规则放到一个自定义链里（例如 CLASH），只维护这一小段规则，避免破坏 Docker/虚拟机等已有 NAT。</p>
</div>
<details class="info">
<summary>命令解释</summary>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>sudo<span class="w"> </span>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-F
</span></code></pre></div>
<ul>
<li><code>-t nat</code>：指定操作 <strong>nat 表</strong>（用于地址/端口转换）  </li>
<li><code>-F</code>：<strong>清空（Flush）</strong> 该表中所有链的规则  </li>
</ul>
</details>
<h4 id="3">3. 保护本机对代理端口的直接访问（非必要）<a class="headerlink" href="#3" title="Permanent link">¶</a></h4>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>sudo<span class="w"> </span>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>OUTPUT<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">7890</span><span class="w"> </span>-j<span class="w"> </span>RETURN
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>sudo<span class="w"> </span>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>OUTPUT<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">7891</span><span class="w"> </span>-j<span class="w"> </span>RETURN
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>sudo<span class="w"> </span>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>OUTPUT<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">7892</span><span class="w"> </span>-j<span class="w"> </span>RETURN
</span></code></pre></div>
<p>这三条规则的作用是：当本机程序<strong>主动连接</strong> Clash 的代理端口（7890/7891/7892）时，立即跳出 NAT 处理（<code>RETURN</code>），不再匹配后续规则。
这是为了防止“<strong>流量自环</strong>”——比如 Clash 自己发起的出站连接又被重定向回自己。  </p>
<blockquote>
<p>这组 OUTPUT 规则主要用于“本机也做透明代理/本机显式代理与透明代理混用”的兼容性场景；如果你只关心局域网设备走网关（只用 PREROUTING 劫持外部流量），通常可以不加。</p>
</blockquote>
<details class="info">
<summary>命令解释</summary>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>sudo<span class="w"> </span>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>OUTPUT<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">7890</span><span class="w"> </span>-j<span class="w"> </span>RETURN
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>sudo<span class="w"> </span>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>OUTPUT<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">7891</span><span class="w"> </span>-j<span class="w"> </span>RETURN
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>sudo<span class="w"> </span>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>OUTPUT<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="m">7892</span><span class="w"> </span>-j<span class="w"> </span>RETURN
</span></code></pre></div>
<ul>
<li><code>-t nat</code>：使用 <strong>nat 表</strong>  </li>
<li><code>-A OUTPUT</code>：向 <strong>本机出站链</strong> 末尾追加规则  </li>
<li><code>-p tcp --dport 789X</code>：匹配目标端口为 Clash 各代理端口（7890/7891/7892）的 TCP 连接  </li>
<li><code>-j RETURN</code>：立即跳出当前链，<strong>不再应用后续 NAT 规则</strong>  </li>
</ul>
</details>
<h4 id="4-tcp">4. 重定向外部 TCP 流量到透明代理端口<a class="headerlink" href="#4-tcp" title="Permanent link">¶</a></h4>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>sudo<span class="w"> </span>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>PREROUTING<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-j<span class="w"> </span>REDIRECT<span class="w"> </span>--to-ports<span class="w"> </span><span class="m">7892</span>
</span></code></pre></div>
<p>这是网关模式的核心：将所有<strong>从网络接口进入的 TCP 流量</strong>（即来自局域网设备的请求）重定向到本地 7892 端口，交由 Clash 的透明代理处理。<br>
此时，Clash 会根据其规则判断该连接是否需要代理，并完成后续的转发。  </p>
<blockquote>
<p>前提条件：其他设备的默认网关已设为这台 Linux 主机（例如通过 Wi-Fi 热点共享）；</p>
</blockquote>
<details class="info">
<summary>命令解释</summary>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>sudo<span class="w"> </span>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>PREROUTING<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-j<span class="w"> </span>REDIRECT<span class="w"> </span>--to-ports<span class="w"> </span><span class="m">7892</span>
</span></code></pre></div>
<ul>
<li><code>-t nat</code>：使用 <strong>nat 表</strong>  </li>
<li><code>-A PREROUTING</code>：向 <strong>路由前入站链</strong> 末尾追加规则  </li>
<li><code>-p tcp</code>：仅处理 <strong>TCP 协议</strong> 流量  </li>
<li><code>-j REDIRECT --to-ports 7892</code>：将匹配的连接<strong>重定向到本机 7892 端口</strong>  </li>
</ul>
<p><strong>翻译：</strong> 将来自局域网设备的 TCP 请求在进入系统前改道至 Clash 的透明代理端口，实现对外部设备的无感代理。</p>
</details>
<div class="admonition warning">
<p class="admonition-title">注意</p>
<p>注意：这条规则会把“局域网访问网关本机的 TCP 服务”（例如 SSH/管理页面）也一起重定向，可能导致连不上网关本机服务。更稳的做法是先绕过内网/保留地址：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="c1"># 可选：先绕过内网/保留地址，避免局域网访问网关本机/内网服务也被劫持</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>sudo<span class="w"> </span>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-I<span class="w"> </span>PREROUTING<span class="w"> </span><span class="m">1</span><span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-d<span class="w"> </span><span class="m">10</span>.0.0.0/8<span class="w"> </span>-j<span class="w"> </span>RETURN
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>sudo<span class="w"> </span>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-I<span class="w"> </span>PREROUTING<span class="w"> </span><span class="m">1</span><span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-d<span class="w"> </span><span class="m">172</span>.16.0.0/12<span class="w"> </span>-j<span class="w"> </span>RETURN
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>sudo<span class="w"> </span>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-I<span class="w"> </span>PREROUTING<span class="w"> </span><span class="m">1</span><span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-d<span class="w"> </span><span class="m">192</span>.168.0.0/16<span class="w"> </span>-j<span class="w"> </span>RETURN
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>sudo<span class="w"> </span>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-I<span class="w"> </span>PREROUTING<span class="w"> </span><span class="m">1</span><span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-d<span class="w"> </span><span class="m">127</span>.0.0.0/8<span class="w"> </span>-j<span class="w"> </span>RETURN
</span></code></pre></div>
<p>参考：<a href="https://blog.waynecommand.com/post/gateway-proxy">网关代理（透明代理）</a></p>
</div>
<h4 id="5-nat">5. 启用转发放行 + 出口 NAT（补充步骤）<a class="headerlink" href="#5-nat" title="Permanent link">¶</a></h4>
<div class="admonition tip">
<p class="admonition-title">说明</p>
<p>项目主页给出的命令只包含了上面的 4 步（开启 IP 转发 + 配置透明代理重定向）。
但在实际部署中，如果希望这台 Linux 稳定地作为局域网设备的默认网关工作，通常还需要补充“转发放行（FORWARD）+ 出口 NAT（MASQUERADE）”这一步。
本节为补充内容，参考了 Wayne 的<a href="https://blog.waynecommand.com/post/gateway-proxy">网关代理（透明代理）</a>一文中的网关配置思路。</p>
<p>但即使如此，本文配置的透明代理规则依然仅覆盖 TCP。若出现部分 App/域名异常，建议优先检查客户端 DNS 是否指向网关，或参考 Wayne 的 DNS 配置一节。</p>
</div>
<p>第 4 步做的是“把局域网来的 TCP 连接交给 Clash 处理”，但这并不等于系统已经具备完整的“网关路由器能力”。</p>
<p>要让局域网设备<strong>真的能通过这台 Linux 上网</strong>，通常还需要补上两件事：</p>
<ol>
<li><strong>允许转发（FORWARD）</strong>：放行局域网 → 外网 的转发流量</li>
<li><strong>出口 NAT（MASQUERADE）</strong>：把局域网私有地址“伪装”成网关自己的外网地址，否则上游路由/运营商无法把回包正确送回局域网设备</li>
</ol>
<p>最简单的补丁如下（按需修改网段）：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1"># 允许转发（简单版：放行所有转发流量）</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>sudo<span class="w"> </span>iptables<span class="w"> </span>-t<span class="w"> </span>filter<span class="w"> </span>-A<span class="w"> </span>FORWARD<span class="w"> </span>-j<span class="w"> </span>ACCEPT
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="c1"># 出口 NAT：把局域网地址伪装成网关自己的外网地址</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="c1"># &lt;LAN_CIDR&gt;：你的局域网网段，例如 192.168.1.0/24</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>sudo<span class="w"> </span>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>POSTROUTING<span class="w"> </span>-s<span class="w"> </span>&lt;LAN_CIDR&gt;<span class="w"> </span>-j<span class="w"> </span>MASQUERADE
</span></code></pre></div>
<blockquote>
<p>如果只做第 4 步、不做这一步，可能出现“部分网站/应用不通、偶尔能用偶尔不行”，看起来像 Clash 配置问题，但本质是<strong>网关转发/NAT 不完整</strong>。</p>
</blockquote>
<details class="info">
<summary>命令解释</summary>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>sudo<span class="w"> </span>iptables<span class="w"> </span>-t<span class="w"> </span>filter<span class="w"> </span>-A<span class="w"> </span>FORWARD<span class="w"> </span>-j<span class="w"> </span>ACCEPT
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>sudo<span class="w"> </span>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>POSTROUTING<span class="w"> </span>-s<span class="w"> </span>&lt;LAN_CIDR&gt;<span class="w"> </span>-j<span class="w"> </span>MASQUERADE
</span></code></pre></div>
<ul>
<li><code>-t filter -A FORWARD -j ACCEPT</code>：在 <strong>filter 表的 FORWARD 链</strong>追加一条规则，允许本机转发通过的流量（让它像路由器一样“转发包”）  </li>
<li><code>-t nat -A POSTROUTING ... -j MASQUERADE</code>：在 <strong>nat 表的 POSTROUTING 链</strong>追加规则，对从指定局域网网段出去的流量做“源地址伪装”（SNAT）  </li>
<li><code>-s &lt;LAN_CIDR&gt;</code>：仅对这个源网段生效（请替换为你的 LAN 网段）  </li>
<li><code>MASQUERADE</code>：一种动态 SNAT 方式，适合网关外网 IP 可能变化（如 DHCP、热点共享）</li>
</ul>
<p><strong>翻译：</strong> 允许局域网设备的流量通过本机转发，并在流量离开网关时做 NAT，让外网回包能正确返回网关，再由网关转发回局域网设备。</p>
</details>
<details class="warning">
<summary>更安全的转发放行（可选）</summary>
<p>上面的 <code>FORWARD -j ACCEPT</code> 是“最省事”的写法，但也最宽松。</p>
<p>如果你希望更保守一点（只放行 “LAN → WAN” 并允许回包），可以用更严格的版本（需要你知道 LAN/WAN 网卡名）：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1"># &lt;LAN_IF&gt;：内网入口网卡（如 wlan0/ap0/eth1）</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="c1"># &lt;WAN_IF&gt;：外网出口网卡（如 eth0/ens33）</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="c1"># &lt;LAN_CIDR&gt;：你的局域网网段（如 192.168.1.0/24）</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>sudo<span class="w"> </span>iptables<span class="w"> </span>-A<span class="w"> </span>FORWARD<span class="w"> </span>-i<span class="w"> </span>&lt;LAN_IF&gt;<span class="w"> </span>-o<span class="w"> </span>&lt;WAN_IF&gt;<span class="w"> </span>-j<span class="w"> </span>ACCEPT
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>sudo<span class="w"> </span>iptables<span class="w"> </span>-A<span class="w"> </span>FORWARD<span class="w"> </span>-i<span class="w"> </span>&lt;WAN_IF&gt;<span class="w"> </span>-o<span class="w"> </span>&lt;LAN_IF&gt;<span class="w"> </span>-m<span class="w"> </span>state<span class="w"> </span>--state<span class="w"> </span>ESTABLISHED,RELATED<span class="w"> </span>-j<span class="w"> </span>ACCEPT
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>sudo<span class="w"> </span>iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>POSTROUTING<span class="w"> </span>-s<span class="w"> </span>&lt;LAN_CIDR&gt;<span class="w"> </span>-o<span class="w"> </span>&lt;WAN_IF&gt;<span class="w"> </span>-j<span class="w"> </span>MASQUERADE
</span></code></pre></div>
</details>
<h3 id="_6">持久化开启（可选）<a class="headerlink" href="#_6" title="Permanent link">¶</a></h3>
<p>前面的配置（特别是 <code>iptables</code> 规则）<strong>仅在当前系统运行期间有效</strong>。一旦重启，所有规则都会丢失，网关代理也将失效。
为了让配置持久化，你需要在系统启动时自动恢复 iptables 规则:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>sudo<span class="w"> </span>iptables-save<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/etc/iptables.rules
</span></code></pre></div>
<p>这会将当前生效的规则导出到 <code>/etc/iptables.rules</code>。</p>
<details class="info">
<summary>命令解释</summary>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>sudo<span class="w"> </span>iptables-save<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/etc/iptables.rules
</span></code></pre></div>
<ul>
<li><code>sudo iptables-save</code>：导出当前所有 iptables 规则为可读文本格式</li>
<li><code>sudo tee /etc/iptables.rules</code>：以 root 权限将规则写入持久化配置文件</li>
</ul>
</details>
<p>不过<strong>保存 ≠ 自动加载</strong>，要实现开机自启动，还需要搭配自动加载机制使用，常见的有两种方案：<code>rc.local</code> 或更现代化的 <code>systemd</code>。</p>
<h4 id="etcrclocal">方案一：使用 <code>/etc/rc.local</code><a class="headerlink" href="#etcrclocal" title="Permanent link">¶</a></h4>
<p>这是一种传统但直观的方法，也是项目主页推荐的方案，适用于快速部署。尽管现代 Linux 发行版已转向 systemd，但多数仍通过兼容服务保留对 /etc/rc.local 的支持。</p>
<blockquote>
<p>在 Ubuntu 16.04+、Debian 9+、CentOS 7+ 等系统中，rc-local.service 默认存在但可能未启用。</p>
</blockquote>
<div class="language-bash highlight"><span class="filename">配置步骤</span><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1"># 创建 /etc/rc.local</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>sudo<span class="w"> </span>cat<span class="w"> </span>&gt;<span class="w"> </span>/etc/rc.local<span class="w"> </span><span class="s">&lt;&lt;EOF</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="s">#!/bin/bash</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="s">iptables-restore &lt; /etc/iptables.rules</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="s">exit 0</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="s">EOF</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="c1"># 赋予执行权限</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>sudo<span class="w"> </span>chmod<span class="w"> </span>+x<span class="w"> </span>/etc/rc.local
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="c1"># 启用兼容服务</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>rc-local
</span></code></pre></div>
<h4 id="systemd">方案二：创建专用 systemd 服务<a class="headerlink" href="#systemd" title="Permanent link">¶</a></h4>
<p>systemd 推荐为每个独立任务定义专属服务。对于恢复防火墙规则，可以创建如下单元文件：</p>
<div class="language-ini highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="c1"># /etc/systemd/system/iptables-restore.service</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="k">[Unit]</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="na">Description</span><span class="o">=</span><span class="s">Restore iptables rules at boot</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="na">After</span><span class="o">=</span><span class="s">network-pre.target</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="na">Before</span><span class="o">=</span><span class="s">network.target</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="k">[Service]</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="na">Type</span><span class="o">=</span><span class="s">oneshot</span>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="na">ExecStart</span><span class="o">=</span><span class="s">/bin/sh -c '/sbin/iptables-restore &lt; /etc/iptables.rules'</span>
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="na">RemainAfterExit</span><span class="o">=</span><span class="s">yes</span>
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a>
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="k">[Install]</span>
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</span></code></pre></div>
<p>然后启用：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>sudo<span class="w"> </span>systemctl<span class="w"> </span>daemon-reload
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>iptables-restore
</span></code></pre></div>
<p>通过以上任一方案，你的 iptables 规则即可在系统重启后自动恢复，确保网关、NAT、端口转发等网络功能持续可用。</p>
<h2 id="_7">结语<a class="headerlink" href="#_7" title="Permanent link">¶</a></h2>
<p>最初只是想搞清楚项目主页上那串 <code>iptables</code> 命令到底在做什么，顺手查了些资料，接触了一点网络虚拟化的概念。整理了不少笔记，觉得扔掉可惜，干脆写成一篇文章。</p>
<p>没想到写着写着，越挖越深，还发现自己之前的一些理解其实存在偏差。于是不断修正、补充，内容也越积越多……一度不得不提醒自己：<strong>别跑太远，回到最初的问题</strong>。</p>
<p>Anyway，总算完成了。</p>
<p>过程中借助了不少 AI 的帮助，虽然尽力核对，但难免疏漏。如果文中仍有错误.....那我先滑跪了。</p>
<h2 id="_8">参考文献<a class="headerlink" href="#_8" title="Permanent link">¶</a></h2>
<ul>
<li><a href="https://www.youtube.com/watch?v=s84CWgKus4U">【全网最细】openclash新手入门教程指南！...</a></li>
<li><a href="https://blog.waynecommand.com/post/gateway-proxy">网关代理（透明代理）</a></li>
<li><a href="https://payloads.online/archivers/2023-08-07/clash-config/">记录一下配置Clash透明代理</a></li>
<li><a href="https://unix.stackexchange.com/questions/471824/what-is-the-correct-substitute-for-rc-local-in-systemd-instead-of-re-creating-rc">What is the correct substitute for rc.local ...</a></li>
</ul>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/the-full" target="_blank" rel="noopener" title="zhazi on github" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["content.action.edit", "content.action.view", "content.code.copy", "content.tooltips", "navigation.tabs", "navigation.instant", "navigation.indexes", "navigation.top", "navigation.tracking"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../_static/js/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>